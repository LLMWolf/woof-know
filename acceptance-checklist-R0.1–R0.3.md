# Acceptance Checklist — СПРИ (R0.1 → R0.3)

Документ служит контрольным листом приёмки по релизам **R0.1 (CLI)**, **R0.2 (WebUI/Text-first)**, **R0.3 (Tables + SQLite)**. Язык: **RU-only** (MVP). Форматы даты/времени: ISO‑8601 UTC.

---

## 0. Общие правила приёмки

* [ ] Все тесты и шаги воспроизводимы по README.
* [ ] Конфигурация валидируется по `settings.schema.json`.
* [ ] OpenAPI 3.1 (`openapi.yaml`) валиден; линт по Spectral — **без ошибок** (warn допустимы, список согласован).
* [ ] Ошибки API соответствуют **RFC7807** (`application/problem+json`).
* [ ] Пагинация (если есть листинги) — курсорная; `limit`=50 по умолчанию, max=500.
* [ ] Небезопасные методы поддерживают `Idempotency-Key`.
* [ ] Rate limit: 100 req/min (429 + `Retry-After`).
* [ ] UI, отчёты и тексты — **только на русском** (до R2).
* [ ] Логи без PII; retention 90 дней.
* [ ] Privacy профили (`strict_local` дефолт, `hybrid`, `cloud_ok`) и **kill-switch** реализованы согласно спецификации.

### RACI

| Роль       | R | A | C | I |
| ---------- | - | - | - | - |
| BA         | ✔ |   | ✔ |   |
| PO         |   | ✔ | ✔ |   |
| Архитектор | ✔ |   | ✔ |   |
| Researcher | ✔ |   | ✔ |   |
| QA         | ✔ |   |   | ✔ |

---

## 1. R0.1 — CLI ядро (Markdown-first)

**Входные условия (Entry):** репозиторий собран; настроен Ollama локально (`llama3.1:8b`); `settings.json` валиден; путь к данным доступен.

**Критерии DoD:**

* [ ] CLI-команда индексации: `spree ingest --paths <...>` обрабатывает `md, txt`; выводит счётчик узлов/чанков и предупреждения.
* [ ] CLI-вопрос: `spree ask --q "..." --k --threshold` — возвращает ответ; при отсутствии релевантных кандидатов — корректный **"нет ответа"**.
* [ ] Экспорт отчёта релевантности (`count`, `threshold`, список источников при флаге) в stdout/JSON.
* [ ] Конфиг `settings.json` считывается и валидируется.
* [ ] Логирование Q&A-событий в локальное хранилище (файл/SQLite не обяз.).
* [ ] `/v1/health` отвечает `{"status":"ok"}`.

**Функциональные тесты:**

* [ ] Индексация каталога с 100+ md/txt файлами завершается без ошибок.
* [ ] Вопросы к известным фактам дают **count>0** и не маркируются как `no_answer`.
* [ ] Контр-тест: вопрос вне корпуса → `no_answer=true`, `count=0`.

**НФ-тесты:**

* [ ] P95 latency ≤ 10 c на локальной машине (набор 20–50 запросов) — по `kpi_smoke.py`.
* [ ] Error rate < 2%.

**Выход (Exit):** чек‑лист выполнен; офлайн‑набор Q&A зафиксирован (freeze T0+10).

---

## 2. R0.2 — WebUI + Text-first (md/txt/docx/pdf-text)

**Entry:** R0.1 принято; деплой WebUI; настроены профили приватности.

**DoD:**

* [ ] WebUI главная включает: поле вопроса, кнопку «Спросить», область ответа, блок источников (по тумблеру), индикатор `count/threshold`, блок фидбэка (thumbs up/down), бейдж режима приватности и **kill-switch**.
* [ ] Профиль `strict_local` активен по умолчанию; при выключенном `allow_external_context` внешние вызовы отсутствуют; при активном kill-switch — блокируются **всегда**.
* [ ] Страница «Настройки» (read‑only) отражает ключи из `settings.json`.
* [ ] Ingest обрабатывает `docx` и `pdf` (только текстовый слой).
* [ ] Ошибки в UI читаемы (RFC7807 details отображаются человеко‑читабельно).

**Тест‑кейсы (функциональные):**

* [ ] **TC‑R02‑01** Многоформатная индексация каталога (`md/txt/docx/pdf`) с лимитами `max_pages/max_mb` — превышение → предсказуемое предупреждение/ошибка.
* [ ] **TC‑R02‑02** Тумблер `show_sources` — список источников появляется/скрывается.
* [ ] **TC‑R02‑03** Тумблер `allow_external_context` — при выключении отсутствуют внешние HTTP‑вызовы (проверка прокси/фаерволом/логом).
* [ ] **TC‑R02‑04** Kill‑switch ON — любые внешние вызовы блокируются независимо от профиля; UI показывает состояние переключателя.
* [ ] **TC‑R02‑05** Thumbs up/down — событие фиксируется; метрики обновляются.

**НФ‑тесты:**

* [ ] P95 ≤ 10 c (набор 20–50 запросов, `kpi_smoke.py`).
* [ ] Hit‑rate@10 ≥ 70% при `show_sources=true` на офлайн‑наборе.
* [ ] "Нет ответа" ≤ 20%.
* [ ] Доступность UI ≥ 99.9% в тестовом окне.

**Security/Privacy:**

* [ ] TLS≥1.2; bearer/OIDC (если включён) работает; роли `admin/user` ограничивают операции.
* [ ] Логи без PII; retention=90 дн.; экспорт персональных данных по запросу пользователя возможен.

**Exit:** демо‑скринкаст + результаты `kpi_smoke.py` приложены.

---

## 3. R0.3 — Табличные данные + SQLite (DB‑дефолт)

**Entry:** R0.2 принято; подготовлен путь к БД и бэкап‑директория.

**DoD:**

* [ ] Поддержка ingest `csv, xlsx` с маппингом в `Node/Chunk` и привязкой `spans.sheet/row`.
* [ ] Включён **SQLite (WAL)** как дефолт для кэша/графа; JSON — экспорт; Parquet — опциональный экспорт.
* [ ] Предоставлен `ddl.sql`; миграции схемы версионируемы (таблица `schema_migrations`).
* [ ] Представления `v_node_chunks`, `v_kpi` доступны.

**Тест‑кейсы:**

* [ ] **TC‑R03‑01** Индексация `csv` с 100k строк — завершается в целевое время; размер БД не выходит за ожидаемые пределы.
* [ ] **TC‑R03‑02** Индексация `xlsx` с несколькими листами; корректные `spans.sheet/row` в ответах/источниках.
* [ ] **TC‑R03‑03** Консистентный бэкап `VACUUM INTO` и восстановление БД → отсутствие потерь.
* [ ] **TC‑R03‑04** Производительность ретрива стабильна после перезапуска (WAL, индексы).

**НФ‑тесты/Ops:**

* [ ] Ежедневные бэкапы включены; квартальный restore‑тест выполнен.
* [ ] P95 ≤ 10 c; error rate < 2% (на эталонном наборе).

**Security/Privacy/Compliance:**

* [ ] Схема БД без PII‑логов; доступ к файлам БД — только у сервиса.

**Exit:** предоставлены бэкап‑артефакты и лог restore‑теста.

---

## 4. Матрица соответствия KPI

| Метрика      | Цель       | Метод измерения                    | Проходной порог |
| ------------ | ---------- | ---------------------------------- | --------------- |
| P95 latency  | ≤ 7–10 с   | `kpi_smoke.py`, 20–50 запросов     | ✅ ≤ 10 с        |
| Hit‑rate@10  | ≥ 0.7      | офлайн‑набор с `show_sources=true` | ✅ ≥ 0.7         |
| Нет ответа   | ≤ 20%      | офлайн‑набор                       | ✅ ≤ 20%         |
| Net‑positive | ≥ +30 п.п. | анализ feedback                    | ✅ ≥ +30 п.п.    |

---

## 5. Проверочный список Security/Privacy (STRIDE)

* [ ] Аутентификация: bearer/OIDC настроены (при включении); токены с TTL.
* [ ] Авторизация: RBAC (`admin`, `user`, `viewer` при необходимости).
* [ ] Шифрование в транзите: TLS≥1.2 (периметр).
* [ ] Kill‑switch: ON блокирует любые внешние вызовы; логируется смена состояния.
* [ ] Анти‑инъекции: нормализация входа/чанков, лимиты размера.
* [ ] DoS‑защита: rate‑limit 100 req/min + backoff.
* [ ] Аудит: действия админа/изменения настроек фиксируются; логи без PII.

---

## 6. Доказательства/Артефакты приёмки

* [ ] Отчёт `kpi_smoke.py` (stdout + CSV при наличии).
* [ ] Валидатор схемы: `settings.example.json` ✓ против `settings.schema.json`.
* [ ] OpenAPI линт (Spectral) — отчёт без ошибок.
* [ ] Скриншоты WebUI (главная, настройки, включённый kill‑switch).
* [ ] Логи ingest для многоформатного каталога и больших таблиц.

---

## 7. Out‑of‑Scope (MVP)

* [ ] OCR/ASR/медиа‑ingest (V1.1+).
* [ ] Реализация Verifier/Reranker (контракты есть, реализация — после MVP).
* [ ] Мультиязычность UI (R2+).
